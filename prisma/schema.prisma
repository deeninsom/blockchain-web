// ========================================================================
// Generator & Datasource
// ========================================================================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========================================================================
// 1. USER (Aktor Sistem)
// ========================================================================
model User {
  id                  String         @id @default(uuid())
  name                String
  email               String         @unique
  password            String
  role                String
  actorAddress        String?        @unique
  encryptedPrivateKey String?
  status              UserStatus     @default(ACTIVE)
  batches             Batch[]
  productEvents       ProductEvent[]
  certificatesIssued  Certificate[]  @relation(name: "CertIssuedBy")
  shipmentLogs        ShipmentLog[]
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
}

// ========================================================================
// 2. BATCH (Indeks Ringan)
// ========================================================================
model Batch {
  id      String @id @default(uuid())
  batchId String @unique

  productName String?

  farmerId         String?
  farmer           User?            @relation(fields: [farmerId], references: [id])
  status           ValidationStatus @default(PENDING)
  rejectionNotes   String?
  verifiedByUserId String?
  events           ProductEvent[]
  certificates     Certificate[]
  shipmentLogs     ShipmentLog[]
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([batchId])
  @@index([farmerId])
}

// ========================================================================
// 3. PRODUCT EVENT (Indeks Verifikasi Blockchain)
// ========================================================================
model ProductEvent {
  id String @id @default(uuid())

  batchId   String
  eventType Int
  ipfsHash  String

  actorAddress   String
  txHash         String   @unique
  blockNumber    BigInt
  logIndex       Int
  blockTimestamp DateTime

  actorUserId String?
  actorUser   User?   @relation(fields: [actorUserId], references: [id])

  batchRefId  String?
  batch       Batch?       @relation(fields: [batchRefId], references: [id])
  shipmentLog ShipmentLog?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([batchId])
  @@index([actorAddress])
  @@index([eventType])
}

// ========================================================================
// 4. CERTIFICATE (Sertifikat Verifikasi Admin)
// ========================================================================
model Certificate {
  id             String   @id @default(uuid())
  batchId        String
  certName       String
  expiryDate     DateTime
  certHash       String
  issuedByUserId String
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  batch    Batch @relation(fields: [batchId], references: [id])
  issuedBy User  @relation(name: "CertIssuedBy", fields: [issuedByUserId], references: [id])

  @@index([issuedByUserId])
}

model ShipmentLog {
  id             String         @id @default(uuid())
  batchRefId     String // ID Batch dari tabel Batch
  status         ShipmentStatus // PICKED atau RECEIVED
  gpsCoordinates String? // Koordinat GPS saat scan (e.g., "Lat,Long")
  notes          String?

  // Tautan ke Aktor
  actorUserId String
  actorUser   User   @relation(fields: [actorUserId], references: [id])

  // Tautan ke Bukti Blockchain
  productEventId String       @unique // Harus UNIQUE karena 1 Tx = 1 Log
  productEvent   ProductEvent @relation(fields: [productEventId], references: [id])

  batchRef Batch @relation(fields: [batchRefId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([batchRefId])
  @@index([actorUserId])
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum ValidationStatus {
  PENDING
  REJECTED
  VERIFIED
  CONFIRMED
}

enum ShipmentStatus {
  PICKED // Diambil/Dimuat (Tx On-Chain)
  RECEIVED // Diterima/Dibongkar (Tx On-Chain)
  SHIPPED // Status Transisi Visual (Off-Chain Only)
}
