// ========================================================================
// Generator & Datasource
// ========================================================================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========================================================================
// 1. USER (Aktor Sistem) - Menyimpan Wallet Address untuk Verifikasi
// ========================================================================
model User {
  id                  String         @id @default(uuid())
  name                String
  email               String         @unique
  password            String
  role                String // FARMER, COLLECTOR, DISTRIBUTOR, RETAILER, ADMIN
  actorAddress        String?        @unique // Wallet Address, Kunci utama interaksi SC
  encryptedPrivateKey String?
  status              UserStatus     @default(ACTIVE)
  batches             Batch[]
  productEvents       ProductEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ========================================================================
// 2. BATCH (Indeks Ringan)
// Bertindak sebagai indeks utama produk.
// ========================================================================
model Batch {
  id      String @id @default(uuid())
  batchId String @unique // ID Batch unik dari aplikasi mobile/SC

  // Metadata ringan untuk pencarian/tampilan cepat
  productName String? // Boleh disimpan untuk filter cepat tanpa IPFS

  farmerId String?
  farmer   User?            @relation(fields: [farmerId], references: [id])
  status   ValidationStatus @default(PENDING)
  events   ProductEvent[] // Relasi ke riwayat event

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([batchId])
  @@index([farmerId])
}

// ========================================================================
// 3. PRODUCT EVENT (Indeks Verifikasi Blockchain)
// Menyimpan bukti On-Chain dan pointer ke data lengkap di IPFS.
// ========================================================================
model ProductEvent {
  id String @id @default(uuid())

  // POINTER & VERIFIKASI UTAMA
  batchId   String // ID Batch terkait (cepat untuk join/query)
  eventType Int // 1=Harvest, 2=Send, dst. (cepat untuk filter)
  ipfsHash  String // HASH IPFS dari Payload JSON event. <-- DATA LENGKAP ADA DI SINI

  // AUDIT BLOCKCHAIN
  actorAddress   String // Wallet address yang menandatangani transaksi
  txHash         String   @unique
  blockNumber    BigInt
  logIndex       Int
  blockTimestamp DateTime // Waktu event dikonfirmasi di blockchain

  // Relasi Off-chain (Optional, untuk menampilkan nama di dashboard)
  actorUserId String?
  actorUser   User?   @relation(fields: [actorUserId], references: [id])

  batchRefId String?
  batch      Batch?  @relation(fields: [batchRefId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([batchId])
  @@index([actorAddress])
  @@index([eventType])
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum ValidationStatus {
  PENDING // Menunggu Review Admin
  REJECTED // Ditolak Admin (Data tidak benar/valid)
  VERIFIED // Disetujui Admin (Siap untuk dicatat di Blockchain)
  CONFIRMED // Sudah dicatat di Blockchain (Final State)
}
